# File Markers v1.0.0 Implementation Plan

## Overview

Implement v1.0.0 features: Marker Inheritance (F9) and Status Bar Summary (F11). This release adds power-user features that improve workflow visibility and file organization.

## Current State Analysis

The v0.3.0 release is complete with:
- Bulk operations (multi-select set/remove markers)
- Folder-based marker removal
- Remove all markers command
- Keyboard toggle (`Ctrl+Shift+M` / `Cmd+Shift+M`)

### Key Files:

- `src/storage.ts:170-176` - `getMarker(uri)` returns direct marker only
- `src/storage.ts:329-343` - `getRelativePath(uri)` for path conversion
- `src/decorationProvider.ts:21-41` - `provideFileDecoration()` returns decoration
- `src/decorationProvider.ts:39` - `propagate: false` (no built-in inheritance)
- `src/extension.ts:9-33` - Extension activation and initialization
- `package.json:16-91` - No `contributes.configuration` section yet

## Desired End State

After implementation:
1. Setting `fileMarkers.inheritFolderMarkers` controls inheritance behavior
2. When enabled, unmarked files inside marked folders show parent's marker with grayed color
3. Status bar shows marker counts: "âœ… 12 | ğŸ”„ 5 | âŒ 8"
4. Clicking status bar opens QuickPick showing detailed statistics
5. Status bar updates in real-time as markers change

### Verification:

**Marker Inheritance:**
- Mark folder `src/` with "Done" (âœ… green)
- Files inside `src/` without explicit markers show âœ… with gray color
- Add explicit marker to `src/file.ts` â†’ shows its own marker (not inherited)
- Remove folder marker â†’ inherited decorations disappear
- Disable setting â†’ all inherited decorations disappear immediately

**Status Bar:**
- Mark 5 files with "Done", 3 with "In Progress", 2 with "Pending"
- Status bar shows "âœ… 5 | ğŸ”„ 3 | âŒ 2"
- Click status bar â†’ QuickPick shows detailed breakdown
- Add another marker â†’ status bar updates automatically
- Remove all markers â†’ status bar shows "No markers"

## What We're NOT Doing

- Custom inheritance depth (always inherits from any ancestor)
- Per-marker-type inheritance settings
- Customizable status bar format
- Filtering Explorer by marker type (no VSCode API support)
- Opening files from status bar QuickPick
- Marketplace polish (separate task)

## Implementation Approach

1. Add configuration setting for inheritance
2. Add storage methods for inheritance lookup and statistics
3. Update decoration provider to handle inherited markers with visual distinction
4. Create StatusBarManager class for status bar item
5. Wire everything together in extension.ts

---

## Phase 1: Add Configuration Setting

### Overview

Add the `fileMarkers.inheritFolderMarkers` configuration setting to package.json and create a helper to read it.

### Changes Required:

#### 1. Update package.json with Configuration

**File**: `package.json`
**Changes**: Add `contributes.configuration` section after `keybindings`

Add this inside the `contributes` object, after the `keybindings` array:

```json
    "configuration": {
      "title": "File Markers",
      "properties": {
        "fileMarkers.inheritFolderMarkers": {
          "type": "boolean",
          "default": false,
          "description": "When enabled, unmarked files inside a marked folder will display a dimmed version of the folder's marker."
        }
      }
    }
```

### Success Criteria:

#### Automated Verification:

- [x] Extension compiles: `pnpm run compile`

#### Manual Verification:

- [x] Open VSCode Settings â†’ search "fileMarkers" â†’ setting appears
- [x] Default value is false
- [x] Setting description is clear

**Implementation Note**: After completing this phase and all automated verification passes, proceed to Phase 2.

---

## Phase 2: Add Storage Methods for Inheritance and Statistics

### Overview

Add methods to MarkerStorage for finding inherited markers from ancestor folders and counting markers by type.

### Changes Required:

#### 1. Add New Methods to MarkerStorage

**File**: `src/storage.ts`
**Changes**: Add new methods after `getMarkerCount()` (around line 313)

```typescript
  /**
   * Get the effective marker for a URI, checking parent folders if no direct marker
   * Returns both the marker ID and whether it's inherited
   */
  getEffectiveMarker(uri: vscode.Uri): { markerId: string; inherited: boolean } | undefined {
    // First check for direct marker
    const directMarker = this.getMarker(uri);
    if (directMarker) {
      return { markerId: directMarker, inherited: false };
    }

    // Check if inheritance is enabled
    const config = vscode.workspace.getConfiguration('fileMarkers');
    if (!config.get<boolean>('inheritFolderMarkers', false)) {
      return undefined;
    }

    // Walk up parent paths to find a folder marker
    const relativePath = this.getRelativePath(uri);
    if (!relativePath) {
      return undefined;
    }

    const parts = relativePath.split('/');
    // Start from immediate parent, walk up to root
    for (let i = parts.length - 1; i >= 1; i--) {
      const parentPath = parts.slice(0, i).join('/');
      const parentMarker = this.markers.get(parentPath);
      if (parentMarker) {
        return { markerId: parentMarker, inherited: true };
      }
    }

    return undefined;
  }

  /**
   * Get marker counts grouped by marker type ID
   */
  getMarkerCountsByType(): Map<string, number> {
    const counts = new Map<string, number>();
    for (const markerId of this.markers.values()) {
      counts.set(markerId, (counts.get(markerId) ?? 0) + 1);
    }
    return counts;
  }
```

### Success Criteria:

#### Automated Verification:

- [x] Type checking passes: `pnpm run check-types`
- [x] Linting passes: `pnpm run lintxx`

**Implementation Note**: After completing this phase and all automated verification passes, proceed to Phase 3.

---

## Phase 3: Update Decoration Provider for Inheritance

### Overview

Update `MarkerDecorationProvider` to use `getEffectiveMarker()` and show inherited markers with a grayed color.

### Changes Required:

#### 1. Add Inherited Marker Color Constant

**File**: `src/decorationProvider.ts`
**Changes**: Add constant after imports (around line 3)

```typescript
/**
 * Color for inherited markers (grayed out)
 */
const INHERITED_MARKER_COLOR = new vscode.ThemeColor('disabledForeground');
```

#### 2. Update provideFileDecoration Method

**File**: `src/decorationProvider.ts`
**Changes**: Replace the `provideFileDecoration` method (lines 21-41)

```typescript
  provideFileDecoration(
    uri: vscode.Uri,
    _token: vscode.CancellationToken
  ): vscode.ProviderResult<vscode.FileDecoration> {
    const effective = this.storage.getEffectiveMarker(uri);
    if (!effective) {
      return undefined;
    }

    const { markerId, inherited } = effective;
    const marker = this.storage.getMarkerType(markerId);
    const isUnknown = marker.id === FALLBACK_MARKER.id;

    // Use grayed color for inherited markers, normal color for direct markers
    let color: vscode.ThemeColor | undefined;
    if (isUnknown) {
      color = undefined;
    } else if (inherited) {
      color = INHERITED_MARKER_COLOR;
    } else {
      color = marker.color;
    }

    // Build tooltip
    let tooltip: string;
    if (isUnknown) {
      tooltip = `Unknown marker type: "${markerId}"`;
    } else if (inherited) {
      tooltip = `File Marker: ${marker.label} (inherited from folder)`;
    } else {
      tooltip = `File Marker: ${marker.label}`;
    }

    return {
      badge: marker.badge,
      color,
      tooltip,
      propagate: false,
    };
  }
```

#### 3. Add Configuration Change Listener

**File**: `src/decorationProvider.ts`
**Changes**: Add configuration listener in constructor, after the existing storage subscription

```typescript
  constructor(private readonly storage: MarkerStorage) {
    this.disposables.push(
      storage.onDidChangeMarkers(event => {
        this._onDidChangeFileDecorations.fire(event.uri);
      })
    );

    // Listen for configuration changes to refresh all decorations
    this.disposables.push(
      vscode.workspace.onDidChangeConfiguration(event => {
        if (event.affectsConfiguration('fileMarkers.inheritFolderMarkers')) {
          this.refresh();
        }
      })
    );
  }
```

### Success Criteria:

#### Automated Verification:

- [x] Type checking passes: `pnpm run check-types`
- [x] Linting passes: `pnpm run lint`

#### Manual Verification:

- [x] Press F5 to launch Extension Development Host
- [x] Create folder `test-folder/` with file `test-folder/file.ts`
- [x] Mark `test-folder/` with "Done" marker
- [x] Enable `fileMarkers.inheritFolderMarkers` in settings
- [x] Verify `test-folder/file.ts` shows âœ… badge with grayed color
- [x] Verify tooltip says "File Marker: Done (inherited from folder)"
- [x] Add explicit marker to `test-folder/file.ts` â†’ shows its own color
- [x] Disable setting â†’ inherited decoration disappears, explicit remains

**Implementation Note**: After completing this phase and all verification passes, proceed to Phase 4.

---

## Phase 4: Create Status Bar Manager

### Overview

Create a new `StatusBarManager` class to display marker statistics and handle click interactions.

### Changes Required:

#### 1. Create StatusBarManager Class

**File**: `src/statusBar.ts` (new file)
**Content**:

```typescript
import * as vscode from 'vscode';
import { MarkerStorage } from './storage';

export class StatusBarManager implements vscode.Disposable {
  private statusBarItem: vscode.StatusBarItem;
  private disposables: vscode.Disposable[] = [];

  constructor(private readonly storage: MarkerStorage) {
    // Create status bar item on the right side
    this.statusBarItem = vscode.window.createStatusBarItem(
      vscode.StatusBarAlignment.Right,
      100
    );
    this.statusBarItem.command = 'file-markers.showMarkerStats';
    this.statusBarItem.tooltip = 'Click to view marker statistics';

    // Update on marker changes
    this.disposables.push(
      storage.onDidChangeMarkers(() => this.update())
    );

    // Initial update
    this.update();
    this.statusBarItem.show();
  }

  update(): void {
    const counts = this.storage.getMarkerCountsByType();
    const total = this.storage.getMarkerCount();

    if (total === 0) {
      this.statusBarItem.text = '$(bookmark) No markers';
      return;
    }

    // Build display text with badges for known marker types
    const parts: string[] = [];
    const markerTypes = this.storage.getAllMarkerTypes();

    for (const markerType of markerTypes) {
      const count = counts.get(markerType.id);
      if (count && count > 0) {
        parts.push(`${markerType.badge} ${count}`);
      }
    }

    // Handle any markers with unknown types
    let unknownCount = 0;
    for (const [markerId, count] of counts) {
      if (!markerTypes.some(m => m.id === markerId)) {
        unknownCount += count;
      }
    }
    if (unknownCount > 0) {
      parts.push(`? ${unknownCount}`);
    }

    this.statusBarItem.text = parts.length > 0 ? parts.join(' | ') : '$(bookmark) No markers';
  }

  async showStats(): Promise<void> {
    const counts = this.storage.getMarkerCountsByType();
    const total = this.storage.getMarkerCount();

    if (total === 0) {
      vscode.window.showInformationMessage('No markers in this workspace.');
      return;
    }

    const markerTypes = this.storage.getAllMarkerTypes();
    const items: vscode.QuickPickItem[] = [];

    // Add header
    items.push({
      label: `Total: ${total} marker${total === 1 ? '' : 's'}`,
      kind: vscode.QuickPickItemKind.Separator,
    });

    // Add each marker type with count
    for (const markerType of markerTypes) {
      const count = counts.get(markerType.id) ?? 0;
      items.push({
        label: `${markerType.badge} ${markerType.label}`,
        description: `${count} file${count === 1 ? '' : 's'}`,
      });
    }

    // Handle any markers with unknown types
    let unknownCount = 0;
    const unknownTypes: string[] = [];
    for (const [markerId, count] of counts) {
      if (!markerTypes.some(m => m.id === markerId)) {
        unknownCount += count;
        unknownTypes.push(markerId);
      }
    }
    if (unknownCount > 0) {
      items.push({
        label: `âš  Unknown markers`,
        description: `${unknownCount} file${unknownCount === 1 ? '' : 's'} (${unknownTypes.join(', ')})`,
      });
    }

    await vscode.window.showQuickPick(items, {
      title: 'File Marker Statistics',
      placeHolder: 'Marker breakdown for this workspace',
    });
  }

  dispose(): void {
    this.statusBarItem.dispose();
    this.disposables.forEach(d => d.dispose());
  }
}
```

#### 2. Register Status Bar Command

**File**: `src/commands.ts`
**Changes**: Add new command at the end of `registerCommands` function (before closing brace)

```typescript
  // Show Marker Stats command (status bar click)
  context.subscriptions.push(
    vscode.commands.registerCommand(
      'file-markers.showMarkerStats',
      () => {
        // This will be called by StatusBarManager
        // We need access to statusBarManager, so we'll handle this differently
      }
    )
  );
```

Actually, we need to handle this differently. Let's register the command in extension.ts where we have access to the StatusBarManager.

#### 2. (Alternative) Update extension.ts to Create StatusBarManager and Register Command

**File**: `src/extension.ts`
**Changes**: Replace entire file content

```typescript
import * as vscode from 'vscode';
import { MarkerStorage } from './storage';
import { MarkerDecorationProvider } from './decorationProvider';
import { StatusBarManager } from './statusBar';
import { registerCommands } from './commands';

let storage: MarkerStorage | undefined;
let decorationProvider: MarkerDecorationProvider | undefined;
let statusBarManager: StatusBarManager | undefined;

export async function activate(
  context: vscode.ExtensionContext
): Promise<void> {
  console.log('File Markers extension is now active');

  // Initialize storage (includes marker type definitions)
  storage = new MarkerStorage();
  await storage.initialize();
  context.subscriptions.push(storage);

  // Initialize decoration provider
  decorationProvider = new MarkerDecorationProvider(storage);
  context.subscriptions.push(decorationProvider);

  // Register decoration provider with VSCode
  context.subscriptions.push(
    vscode.window.registerFileDecorationProvider(decorationProvider)
  );

  // Initialize status bar
  statusBarManager = new StatusBarManager(storage);
  context.subscriptions.push(statusBarManager);

  // Register status bar command
  context.subscriptions.push(
    vscode.commands.registerCommand('file-markers.showMarkerStats', () => {
      statusBarManager?.showStats();
    })
  );

  // Register other commands
  registerCommands(context, storage);

  // Refresh decorations after initialization
  decorationProvider.refresh();
}

export function deactivate(): void {
  storage = undefined;
  decorationProvider = undefined;
  statusBarManager = undefined;
}
```

#### 3. Add Command to package.json

**File**: `package.json`
**Changes**: Add new command to `contributes.commands` array

```json
      {
        "command": "file-markers.showMarkerStats",
        "title": "File Markers: Show Marker Statistics"
      }
```

#### 4. Add Command to Command Palette

**File**: `package.json`
**Changes**: Add to `contributes.menus.commandPalette` array

```json
        {
          "command": "file-markers.showMarkerStats"
        }
```

### Success Criteria:

#### Automated Verification:

- [x] Type checking passes: `pnpm run check-types`
- [x] Linting passes: `pnpm run lint`
- [x] Extension compiles: `pnpm run compile`

#### Manual Verification:

- [x] Press F5 to launch Extension Development Host
- [x] Status bar shows "No markers" initially (left side, configurable)
- [x] Mark 3 files with "Done" â†’ status bar shows "âœ… 3"
- [x] Mark 2 files with "In Progress" â†’ status bar shows "âœ… 3 | ğŸ”„ 2"
- [x] Click status bar â†’ QuickPick shows detailed breakdown
- [x] Remove all markers â†’ status bar shows "No markers"

**Implementation Note**: After completing this phase and all verification passes, proceed to Phase 5.

---

## Phase 5: Update Version and Final Verification

### Overview

Update package.json version to 1.0.0 and perform final verification.

### Changes Required:

#### 1. Update package.json version

**File**: `package.json`
**Changes**: Update version field

```json
"version": "1.0.0"
```

### Success Criteria:

#### Automated Verification:

- [x] Extension compiles: `pnpm run compile`
- [x] Type checking passes: `pnpm run check-types`
- [x] Linting passes: `pnpm run lint`

#### Manual Verification:

- [x] Full inheritance workflow:
  - Create nested folders: `parent/child/grandchild/file.ts`
  - Mark `parent/` with "Done"
  - Enable inheritance setting
  - Verify all nested items show inherited markers (grayed)
  - Mark `parent/child/` with "In Progress"
  - Verify `parent/child/grandchild/file.ts` inherits from `child/` (closer ancestor)
  - Disable inheritance â†’ only direct markers shown

- [x] Full status bar workflow:
  - Mark files with various marker types
  - Verify status bar updates in real-time
  - Click status bar â†’ see statistics
  - Use "Remove All Markers" â†’ status bar shows "No markers"

- [x] Edge cases:
  - Empty workspace (no markers) â†’ status bar shows "No markers"
  - Mark workspace root folder â†’ all files inherit
  - Custom marker types in config â†’ appear in status bar

**Implementation Note**: After completing this phase and all verification passes, v1.0.0 is complete.

---

## Testing Strategy

### Manual Testing Steps:

1. **Inheritance - Basic**
   - Create `src/` folder with 3 files
   - Mark `src/` folder with "Done" (âœ…)
   - Enable `fileMarkers.inheritFolderMarkers`
   - Verify all 3 files show âœ… with grayed color
   - Hover over file â†’ tooltip says "(inherited from folder)"

2. **Inheritance - Override**
   - With inheritance enabled and `src/` marked
   - Mark `src/file1.ts` with "In Progress" (ğŸ”„)
   - Verify `file1.ts` shows ğŸ”„ with original color (not grayed)
   - Other files still show inherited âœ…

3. **Inheritance - Nested Folders**
   - Create `a/b/c/file.ts`
   - Mark `a/` with "Done", mark `a/b/` with "Pending"
   - Verify `a/b/c/file.ts` inherits from `a/b/` (closer parent)
   - Remove marker from `a/b/`
   - Verify `a/b/c/file.ts` now inherits from `a/`

4. **Inheritance - Setting Toggle**
   - With folder marked and files inheriting
   - Disable `fileMarkers.inheritFolderMarkers`
   - Verify inherited decorations disappear immediately
   - Direct folder marker remains visible
   - Re-enable setting â†’ inherited decorations reappear

5. **Status Bar - Display**
   - Mark 5 files: 2 Done, 2 In Progress, 1 Pending
   - Verify status bar shows "âœ… 2 | ğŸ”„ 2 | âŒ 1"
   - Add 1 more Done marker
   - Verify status bar updates to "âœ… 3 | ğŸ”„ 2 | âŒ 1"

6. **Status Bar - QuickPick**
   - Click status bar
   - Verify QuickPick shows:
     - Total count
     - Each marker type with badge and count
   - Click outside to dismiss

7. **Status Bar - Empty State**
   - Remove all markers
   - Verify status bar shows "No markers"
   - Click status bar â†’ shows "No markers in this workspace" message

8. **Edge Cases**
   - Inheritance on workspace root folder
   - Unknown marker types in storage
   - Mix of file and folder markers
   - Rapid marker changes (debouncing)

## File Structure After Implementation

```
src/
â”œâ”€â”€ extension.ts          # Entry point + status bar command
â”œâ”€â”€ types.ts              # TypeScript interfaces (unchanged)
â”œâ”€â”€ defaults.ts           # Default marker types (unchanged)
â”œâ”€â”€ storage.ts            # MarkerStorage with inheritance + stats methods
â”œâ”€â”€ decorationProvider.ts # FileDecorationProvider with inheritance support
â”œâ”€â”€ statusBar.ts          # NEW: StatusBarManager class
â”œâ”€â”€ commands.ts           # Command registrations (unchanged)
â””â”€â”€ test/
    â””â”€â”€ extension.test.ts # Tests
```

## References

- v0.3.0 Plan: `thoughts/shared/plans/2026-01-31-v0.3.0-bulk-operations-keyboard.md`
- PRD: `PRD.md` (F9: Marker Inheritance, F11: Status Bar Summary)
- VSCode FileDecoration API: https://code.visualstudio.com/api/references/vscode-api#FileDecoration
- VSCode Configuration: https://code.visualstudio.com/api/references/contribution-points#contributes.configuration
- VSCode StatusBarItem: https://code.visualstudio.com/api/references/vscode-api#StatusBarItem
