# File Markers v0.3.0 Implementation Plan

## Overview

Implement v0.3.0 features: Bulk operations for managing markers on multiple files at once, and keyboard shortcuts for quick marker toggling. This release focuses on power-user productivity.

## Current State Analysis

The v0.2.0 release is complete with:
- QuickPick-based marker selection via `file-markers.addMarker`
- Single-file marker removal via `file-markers.removeMarker`
- Configurable marker types in `.vscode/file-markers.json`
- `MarkerStorage` class with `getAllMarkedUris()` method (useful for bulk operations)

### Key Files:

- `src/commands.ts:11-43` - `addMarker` command takes single `uri: vscode.Uri`
- `src/commands.ts:46-62` - `removeMarker` command takes single `uri: vscode.Uri`
- `src/storage.ts:217-226` - `getAllMarkedUris()` returns all marked files
- `src/storage.ts:228-241` - `getRelativePath()` private method for path conversion
- `package.json:17-55` - Current command and menu contributions

## Desired End State

After implementation:
1. Multi-select files in Explorer → right-click → "Set Marker..." applies to all selected
2. Multi-select files in Explorer → right-click → "Remove Marker" removes from all selected
3. Right-click folder → "Remove Markers in Folder" clears all markers within that folder
4. Command Palette → "File Markers: Remove All Markers" clears entire workspace
5. Keyboard shortcut (`Ctrl+Shift+M` / `Cmd+Shift+M`) cycles through markers on active file
6. Cycle order: no marker → done → in-progress → pending → no marker

### Verification:

- Multi-select 3 files → Set Marker → select "Done" → all 3 show ✓
- Multi-select 2 marked files → Remove Marker → both badges disappear
- Right-click folder with 5 marked children → "Remove Markers in Folder" → all 5 cleared
- Command Palette → "Remove All Markers" → confirm → all workspace markers cleared
- Open file → press `Ctrl+Shift+M` → marker cycles through states
- Press shortcut on unmarked file → "Done" applied
- Press shortcut on "Done" file → "In Progress" applied
- Press shortcut on "Pending" file → marker removed

## What We're NOT Doing

- Keyboard shortcuts for specific marker types (only cycle toggle)
- Custom cycle order configuration (hardcoded: done → in-progress → pending)
- Recursive folder marker application (only removal, not addition)
- Undo support for bulk operations
- Progress indicators for large operations

## Implementation Approach

1. Update commands to handle multi-select (VSCode passes `uris` array)
2. Add storage methods for bulk and folder-based operations
3. Add new commands for folder removal and clear all
4. Add keyboard shortcut command with cycle logic
5. Update package.json with new commands, menus, and keybindings

---

## Phase 1: Update Storage for Bulk Operations

### Overview

Add methods to MarkerStorage for bulk operations and folder-based marker removal.

### Changes Required:

#### 1. Add Bulk and Folder Methods to MarkerStorage

**File**: `src/storage.ts`
**Changes**: Add new methods after existing `removeMarker` method (around line 205)

```typescript
  /**
   * Set markers for multiple URIs at once
   */
  setMarkers(uris: vscode.Uri[], markerId: string): void {
    for (const uri of uris) {
      const relativePath = this.getRelativePath(uri);
      if (relativePath) {
        this.markers.set(relativePath, markerId);
        this._onDidChangeMarkers.fire({ uri, markerId });
      }
    }
    this.scheduleSave();
  }

  /**
   * Remove markers from multiple URIs at once
   */
  removeMarkers(uris: vscode.Uri[]): void {
    let changed = false;
    for (const uri of uris) {
      const relativePath = this.getRelativePath(uri);
      if (relativePath && this.markers.delete(relativePath)) {
        changed = true;
        this._onDidChangeMarkers.fire({ uri, markerId: undefined });
      }
    }
    if (changed) {
      this.scheduleSave();
    }
  }

  /**
   * Remove all markers within a folder (and subfolders)
   */
  removeMarkersInFolder(folderUri: vscode.Uri): number {
    const folderPath = this.getRelativePath(folderUri);
    if (!folderPath) {
      return 0;
    }

    const workspaceFolder = vscode.workspace.workspaceFolders?.[0];
    if (!workspaceFolder) {
      return 0;
    }

    const prefix = folderPath + '/';
    const toRemove: string[] = [];

    for (const relativePath of this.markers.keys()) {
      // Match exact folder or any path starting with folder/
      if (relativePath === folderPath || relativePath.startsWith(prefix)) {
        toRemove.push(relativePath);
      }
    }

    for (const relativePath of toRemove) {
      this.markers.delete(relativePath);
      const uri = vscode.Uri.joinPath(workspaceFolder.uri, relativePath);
      this._onDidChangeMarkers.fire({ uri, markerId: undefined });
    }

    if (toRemove.length > 0) {
      this.scheduleSave();
    }

    return toRemove.length;
  }

  /**
   * Remove all markers in the workspace
   */
  removeAllMarkers(): number {
    const count = this.markers.size;
    if (count === 0) {
      return 0;
    }

    const workspaceFolder = vscode.workspace.workspaceFolders?.[0];
    if (!workspaceFolder) {
      return 0;
    }

    // Fire events for all removed markers
    for (const relativePath of this.markers.keys()) {
      const uri = vscode.Uri.joinPath(workspaceFolder.uri, relativePath);
      this._onDidChangeMarkers.fire({ uri, markerId: undefined });
    }

    this.markers.clear();
    this.scheduleSave();

    return count;
  }

  /**
   * Get total number of markers
   */
  getMarkerCount(): number {
    return this.markers.size;
  }
```

### Success Criteria:

#### Automated Verification:

- [x] Type checking passes: `pnpm run check-types`
- [x] Linting passes: `pnpm run lint`

**Implementation Note**: After completing this phase and all automated verification passes, proceed to Phase 2.

---

## Phase 2: Update Existing Commands for Multi-Select

### Overview

Modify `addMarker` and `removeMarker` commands to handle multiple selected files in Explorer.

### Changes Required:

#### 1. Update Commands Module

**File**: `src/commands.ts`
**Changes**: Update command handlers to accept `uris` array parameter

Replace the entire file content:

```typescript
import * as vscode from 'vscode';
import { MarkerStorage } from './storage';
import { DEFAULT_MARKER_TYPES } from './defaults';

export function registerCommands(
  context: vscode.ExtensionContext,
  storage: MarkerStorage
): void {
  // Add Marker command with QuickPick (supports multi-select)
  context.subscriptions.push(
    vscode.commands.registerCommand(
      'file-markers.addMarker',
      async (uri: vscode.Uri, uris?: vscode.Uri[]) => {
        // When multi-selecting in Explorer, VSCode passes clicked item as uri
        // and all selected items as uris array
        const targets = uris && uris.length > 0 ? uris : uri ? [uri] : [];

        if (targets.length === 0) {
          return;
        }

        const markerTypes = storage.getAllMarkerTypes();
        if (markerTypes.length === 0) {
          vscode.window.showWarningMessage(
            'No marker types configured. Open configuration to add marker types.'
          );
          return;
        }

        // For single file, show current marker
        const currentMarkerId = targets.length === 1
          ? storage.getMarker(targets[0])
          : undefined;

        const items = markerTypes.map(m => ({
          label: `${m.badge} ${m.label}`,
          description: m.id === currentMarkerId ? '(current)' : undefined,
          markerId: m.id,
        }));

        const placeHolder = targets.length === 1
          ? 'Select a marker to apply'
          : `Select a marker to apply to ${targets.length} items`;

        const selected = await vscode.window.showQuickPick(items, {
          placeHolder,
        });

        if (selected) {
          storage.setMarkers(targets, selected.markerId);
        }
      }
    )
  );

  // Remove Marker command (supports multi-select)
  context.subscriptions.push(
    vscode.commands.registerCommand(
      'file-markers.removeMarker',
      (uri: vscode.Uri, uris?: vscode.Uri[]) => {
        const targets = uris && uris.length > 0 ? uris : uri ? [uri] : [];

        if (targets.length === 0) {
          return;
        }

        storage.removeMarkers(targets);
      }
    )
  );

  // Open Configuration command
  context.subscriptions.push(
    vscode.commands.registerCommand(
      'file-markers.openConfig',
      async () => {
        const storageUri = storage.getStorageUri();
        if (!storageUri) {
          vscode.window.showWarningMessage(
            'No workspace folder open. Open a folder first.'
          );
          return;
        }

        // Ensure file exists before opening
        try {
          await vscode.workspace.fs.stat(storageUri);
        } catch {
          // File doesn't exist, create it with defaults
          const initialData = {
            markerTypes: DEFAULT_MARKER_TYPES,
            markers: {},
          };
          const content = Buffer.from(JSON.stringify(initialData, null, 2), 'utf8');

          // Ensure .vscode directory exists
          const vscodeDir = vscode.Uri.joinPath(storageUri, '..');
          try {
            await vscode.workspace.fs.createDirectory(vscodeDir);
          } catch {
            // Directory may already exist
          }

          await vscode.workspace.fs.writeFile(storageUri, content);
        }

        const doc = await vscode.workspace.openTextDocument(storageUri);
        await vscode.window.showTextDocument(doc);
      }
    )
  );
}
```

### Success Criteria:

#### Automated Verification:

- [x] Type checking passes: `pnpm run check-types`
- [x] Linting passes: `pnpm run lint`

**Implementation Note**: After completing this phase and all automated verification passes, proceed to Phase 3.

---

## Phase 3: Add New Bulk Commands

### Overview

Add commands for "Remove Markers in Folder" and "Remove All Markers".

### Changes Required:

#### 1. Add New Commands to Commands Module

**File**: `src/commands.ts`
**Changes**: Add new commands after the `openConfig` command (before the closing brace of `registerCommands`)

Add these commands inside the `registerCommands` function:

```typescript
  // Remove Markers in Folder command
  context.subscriptions.push(
    vscode.commands.registerCommand(
      'file-markers.removeMarkersInFolder',
      async (uri: vscode.Uri) => {
        if (!uri) {
          return;
        }

        const count = storage.removeMarkersInFolder(uri);
        if (count > 0) {
          vscode.window.showInformationMessage(
            `Removed ${count} marker${count === 1 ? '' : 's'} from folder.`
          );
        } else {
          vscode.window.showInformationMessage('No markers found in folder.');
        }
      }
    )
  );

  // Remove All Markers command
  context.subscriptions.push(
    vscode.commands.registerCommand(
      'file-markers.removeAllMarkers',
      async () => {
        const markerCount = storage.getMarkerCount();
        if (markerCount === 0) {
          vscode.window.showInformationMessage('No markers to remove.');
          return;
        }

        const confirm = await vscode.window.showWarningMessage(
          `Remove all ${markerCount} marker${markerCount === 1 ? '' : 's'} from this workspace?`,
          { modal: true },
          'Remove All'
        );

        if (confirm === 'Remove All') {
          const removed = storage.removeAllMarkers();
          vscode.window.showInformationMessage(
            `Removed ${removed} marker${removed === 1 ? '' : 's'}.`
          );
        }
      }
    )
  );
```

### Success Criteria:

#### Automated Verification:

- [x] Type checking passes: `pnpm run check-types`
- [x] Linting passes: `pnpm run lint`

**Implementation Note**: After completing this phase and all automated verification passes, proceed to Phase 4.

---

## Phase 4: Add Keyboard Toggle Command

### Overview

Add a command that cycles through markers on the active editor file using a keyboard shortcut.

### Changes Required:

#### 1. Add Toggle Command to Commands Module

**File**: `src/commands.ts`
**Changes**: Add the toggle command inside `registerCommands` function

```typescript
  // Toggle Marker command (keyboard shortcut)
  // Cycles: no marker → done → in-progress → pending → no marker
  context.subscriptions.push(
    vscode.commands.registerCommand(
      'file-markers.toggleMarker',
      () => {
        const editor = vscode.window.activeTextEditor;
        if (!editor) {
          vscode.window.showWarningMessage('No active file to toggle marker.');
          return;
        }

        const uri = editor.document.uri;
        const currentMarkerId = storage.getMarker(uri);

        // Define cycle order (uses first 3 default marker IDs)
        const cycleOrder = ['done', 'in-progress', 'pending'];

        if (!currentMarkerId) {
          // No marker → apply first in cycle
          storage.setMarker(uri, cycleOrder[0]);
        } else {
          const currentIndex = cycleOrder.indexOf(currentMarkerId);
          if (currentIndex === -1) {
            // Current marker not in cycle → remove it
            storage.removeMarker(uri);
          } else if (currentIndex === cycleOrder.length - 1) {
            // Last in cycle → remove marker
            storage.removeMarker(uri);
          } else {
            // Move to next in cycle
            storage.setMarker(uri, cycleOrder[currentIndex + 1]);
          }
        }
      }
    )
  );
```

### Success Criteria:

#### Automated Verification:

- [x] Type checking passes: `pnpm run check-types`
- [x] Linting passes: `pnpm run lint`

**Implementation Note**: After completing this phase and all automated verification passes, proceed to Phase 5.

---

## Phase 5: Update package.json

### Overview

Add new commands, menu items, and keyboard shortcuts to package.json.

### Changes Required:

#### 1. Update package.json contributes section

**File**: `package.json`
**Changes**: Replace the entire `contributes` section

```json
{
  "contributes": {
    "commands": [
      {
        "command": "file-markers.addMarker",
        "title": "File Markers: Add Marker..."
      },
      {
        "command": "file-markers.removeMarker",
        "title": "File Markers: Remove Marker"
      },
      {
        "command": "file-markers.removeMarkersInFolder",
        "title": "File Markers: Remove Markers in Folder"
      },
      {
        "command": "file-markers.removeAllMarkers",
        "title": "File Markers: Remove All Markers"
      },
      {
        "command": "file-markers.toggleMarker",
        "title": "File Markers: Toggle Marker"
      },
      {
        "command": "file-markers.openConfig",
        "title": "File Markers: Open Configuration"
      }
    ],
    "menus": {
      "explorer/context": [
        {
          "command": "file-markers.addMarker",
          "group": "2_workspace@1"
        },
        {
          "command": "file-markers.removeMarker",
          "group": "2_workspace@2"
        },
        {
          "command": "file-markers.removeMarkersInFolder",
          "group": "2_workspace@3",
          "when": "explorerResourceIsFolder"
        }
      ],
      "commandPalette": [
        {
          "command": "file-markers.addMarker",
          "when": "false"
        },
        {
          "command": "file-markers.removeMarker",
          "when": "false"
        },
        {
          "command": "file-markers.removeMarkersInFolder",
          "when": "false"
        },
        {
          "command": "file-markers.removeAllMarkers"
        },
        {
          "command": "file-markers.toggleMarker"
        },
        {
          "command": "file-markers.openConfig"
        }
      ]
    },
    "keybindings": [
      {
        "command": "file-markers.toggleMarker",
        "key": "ctrl+shift+m",
        "mac": "cmd+shift+m",
        "when": "editorTextFocus"
      }
    ]
  }
}
```

#### 2. Update package.json version

**File**: `package.json`
**Changes**: Bump version to 0.3.0

```json
{
  "version": "0.3.0"
}
```

### Success Criteria:

#### Automated Verification:

- [x] Extension compiles: `pnpm run compile`

#### Manual Verification:

- [x] Press F5 to launch Extension Development Host
- [x] Multi-select 3 files → right-click → "Set Marker..." → select marker → all 3 get badge
- [x] Multi-select 2 marked files → right-click → "Remove Marker" → both badges removed
- [x] Right-click folder → "Remove Markers in Folder" visible (only on folders)
- [x] Click "Remove Markers in Folder" → shows count message
- [x] Command Palette → "File Markers: Remove All Markers" → shows confirmation → clears all
- [x] Open a file → press `Ctrl+Shift+M` (or `Cmd+Shift+M` on Mac) → marker cycles
- [x] Verify cycle: no marker → ✓ Done → ◐ In Progress → ○ Pending → no marker

**Implementation Note**: After completing this phase and all verification passes, v0.3.0 is complete.

---

## Testing Strategy

### Manual Testing Steps:

1. **Multi-select set marker**
   - Hold Ctrl/Cmd and click 3 different files in Explorer
   - Right-click → "Set Marker..." → select "Done"
   - Verify all 3 files show ✓ badge

2. **Multi-select remove marker**
   - Mark 3 files with different markers
   - Hold Ctrl/Cmd and select 2 of them
   - Right-click → "Remove Marker"
   - Verify those 2 badges are gone, third remains

3. **Remove markers in folder**
   - Create folder with 5 files, mark 3 of them
   - Right-click folder → "Remove Markers in Folder"
   - Verify message shows "Removed 3 markers"
   - Verify all badges in folder are gone

4. **Remove all markers**
   - Mark 5 files across different folders
   - Command Palette → "File Markers: Remove All Markers"
   - Click "Remove All" in confirmation dialog
   - Verify all markers removed

5. **Keyboard toggle**
   - Open unmarked file
   - Press `Ctrl+Shift+M` → verify "Done" marker appears
   - Press again → verify "In Progress" marker
   - Press again → verify "Pending" marker
   - Press again → verify marker removed
   - Open file with custom marker (e.g., "Important")
   - Press `Ctrl+Shift+M` → verify marker removed (not in cycle)

6. **Edge cases**
   - Remove markers in empty folder (should show "No markers found")
   - Remove all markers when none exist (should show "No markers to remove")
   - Toggle marker with no editor open (should show warning)
   - Multi-select with mix of marked/unmarked files

## File Structure After Implementation

```
src/
├── extension.ts          # Entry point (unchanged)
├── types.ts              # TypeScript interfaces (unchanged)
├── defaults.ts           # Default marker types (unchanged)
├── storage.ts            # MarkerStorage with bulk methods
├── decorationProvider.ts # FileDecorationProvider (unchanged)
├── commands.ts           # Command registrations with bulk + toggle
└── test/
    └── extension.test.ts # Tests
```

## References

- v0.2.0 Plan: `thoughts/shared/plans/2026-01-31-v0.2.0-custom-markers-settings.md`
- PRD: `PRD.md` (F8: Bulk Operations, F10: Quick Toggle)
- VSCode Multi-Select: Explorer passes `(uri, uris)` to commands
- VSCode Keybindings: https://code.visualstudio.com/docs/getstarted/keybindings
